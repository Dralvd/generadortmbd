<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Código para Películas y Series</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Scripts de Google API -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .code-block {
            background-color: #1e293b; /* slate-800 */
            color: #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .copy-button:hover {
            background-color: #475569; /* slate-600 */
        }
        .custom-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            border: none;
            white-space: nowrap;
        }
        .custom-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #searchResultsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            max-height: 340px; /* Altura máxima para una fila */
            overflow-y: auto;   /* Scroll vertical si el contenido excede la altura */
            padding: 0.5rem;      /* Pequeño padding para que se vea mejor */
            background-color: #1e293b; /* Fondo ligeramente diferente */
            border-radius: 0.5rem;
        }
        .search-result-item {
            background-color: #334155;
            border-radius: 0.5rem;
            overflow: hidden;
            text-align: center;
        }
        .search-result-item img {
            width: 100%;
            height: auto;
            aspect-ratio: 2/3;
            object-fit: cover;
        }
        .search-result-item p {
            padding: 0.5rem;
            font-size: 0.875rem;
            min-height: 50px;
        }
        .tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
            border-bottom-width: 2px;
            cursor: pointer;
        }
        .tab-active {
            border-color: #38bdf8; /* sky-400 */
            color: #e2e8f0; /* slate-200 */
        }
        .tab-inactive {
            border-color: transparent;
            color: #94a3b8; /* slate-400 */
        }
        .tab-inactive:hover {
            border-color: #475569; /* slate-600 */
            color: #cbd5e1; /* slate-300 */
        }
    </style>
</head>
<body class="bg-slate-900 text-white p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Generador de Contenido</h1>
            <p class="text-slate-400 mt-2">Crea código para tus entradas de películas o series.</p>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-4 border-b border-slate-700">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button id="tabGenerator" class="tab-btn tab-active">Generador</button>
                <button id="tabConfig" class="tab-btn tab-inactive">Configuración de APIs</button>
            </nav>
        </div>

        <!-- Panel de Generador -->
        <div id="panelGenerator">
            <!-- Selector de Tipo -->
            <div class="mb-8 bg-slate-800 p-4 rounded-lg flex justify-center gap-4">
                <label class="font-medium text-slate-300">Tipo de Contenido:</label>
                <div>
                    <input type="radio" id="typeMovie" name="contentType" value="movie" checked>
                    <label for="typeMovie">Película</label>
                </div>
                <div>
                    <input type="radio" id="typeSeries" name="contentType" value="tv">
                    <label for="typeSeries">Serie</label>
                </div>
            </div>

            <!-- Sección de búsqueda de TMDb -->
            <div id="tmdbSearchSection" class="bg-slate-800 p-6 rounded-lg shadow-lg mb-8 space-y-4">
                <h2 class="text-xl font-semibold text-teal-400 border-b border-teal-500 pb-2">Buscador (TMDb)</h2>
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-slate-300 mb-2">Buscar por Título</label>
                    <div class="flex gap-2">
                        <input type="text" id="searchInput" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" placeholder="Ej: The Matrix / The Simpsons">
                        <button id="searchBtn" class="custom-btn bg-sky-600 hover:bg-sky-700 text-white">Buscar</button>
                    </div>
                </div>
                <div id="searchResultsContainer" class="mt-4"></div>
            </div>

            <!-- Formulario para ingresar los datos -->
            <form id="contentForm" class="bg-slate-800 p-6 rounded-lg shadow-lg space-y-6">
                <div>
                    <label for="postTitle" class="block text-sm font-medium text-slate-300 mb-2">Título de la Entrada</label>
                    <input type="text" id="postTitle" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="Ej: Nombre de la Película (Año)" required>
                </div>
                <div>
                    <label for="imageUrl" class="block text-sm font-medium text-slate-300 mb-2">URL de la Imagen (Póster)</label>
                    <input type="url" id="imageUrl" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="https://ejemplo.com/poster.jpg" required>
                </div>
                <div>
                    <label for="imageAltText" class="block text-sm font-medium text-slate-300 mb-2">Texto Alternativo para la Imagen (SEO)</label>
                    <textarea id="imageAltText" rows="2" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="Títulos alternativos para optimizar la búsqueda..."></textarea>
                </div>
                <div>
                    <label for="synopsis" class="block text-sm font-medium text-slate-300 mb-2">Sinopsis</label>
                    <textarea id="synopsis" rows="4" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="Escribe aquí la sinopsis..." required></textarea>
                </div>
                 <div id="movieFields">
                    <div>
                        <label for="server1" class="block text-sm font-medium text-slate-300 mb-2">Embed del Servidor 1</label>
                        <input type="url" id="server1" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="https://servidor1.com/embed/..." required>
                    </div>
                    <div>
                        <label for="server2" class="block text-sm font-medium text-slate-300 mb-2">Embed del Servidor 2</label>
                        <input type="url" id="server2" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="https://servidor2.com/embed/..." required>
                    </div>
                    <div>
                        <label for="downloadUrl" class="block text-sm font-medium text-slate-300 mb-2">URL de Descarga</label>
                        <input type="url" id="downloadUrl" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="https://ejemplo.com/pelicula.mp4" required>
                    </div>
                </div>
                <div id="seriesFields" class="hidden space-y-4">
                     <h3 class="text-lg font-semibold text-slate-300 border-b border-slate-600 pb-2">Episodios</h3>
                     <div id="episodesContainer" class="space-y-3">
                         <!-- Los campos de episodios se añadirán aquí -->
                     </div>
                     <button type="button" id="addEpisodeBtn" class="custom-btn bg-indigo-600 hover:bg-indigo-700 text-white">Añadir Episodio</button>
                </div>
                 <div>
                    <label for="postLabels" class="block text-sm font-medium text-slate-300 mb-2">Etiquetas (separadas por comas)</label>
                    <input type="text" id="postLabels" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white focus:ring-2 focus:ring-sky-500" placeholder="Ej: Acción, Aventura, Estreno">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="publish_button" class="custom-btn bg-amber-600 hover:bg-amber-700 text-white" disabled>Publicar en Blogger</button>
                    <button type="button" id="generateCodeBtn" class="bg-sky-600 hover:bg-sky-700 text-white custom-btn">
                        Generar Código HTML
                    </button>
                </div>
            </form>
        </div>

        <!-- Panel de Configuración -->
        <div id="panelConfig" class="hidden">
            <!-- Sección de configuración de TMDb -->
            <div class="bg-slate-800 p-6 rounded-lg shadow-lg mb-8 space-y-4">
                <h2 class="text-xl font-semibold text-teal-400 border-b border-teal-500 pb-2">Configuración de TMDb</h2>
                <div>
                    <label for="tmdbApiKey" class="block text-sm font-medium text-slate-300 mb-2">Tu API Key de TMDb</label>
                    <div class="flex gap-2">
                        <input type="password" id="tmdbApiKey" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" placeholder="Introduce tu API Key de TMDb">
                        <button id="save_tmdb_key_button" class="custom-btn bg-teal-600 hover:bg-teal-700 text-white">Guardar</button>
                    </div>
                </div>
            </div>
            <!-- Sección de publicación en Blogger -->
            <div id="bloggerSection" class="bg-slate-800 p-6 rounded-lg shadow-lg mt-8 space-y-4">
                <h2 class="text-xl font-semibold text-amber-400 border-b border-amber-500 pb-2">Configuración de Blogger</h2>
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-slate-300 mb-2">Tu Google API Key</label>
                    <input type="password" id="apiKey" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" placeholder="Introduce tu API Key">
                </div>
                <div>
                    <label for="clientId" class="block text-sm font-medium text-slate-300 mb-2">Tu Google Client ID</label>
                    <input type="password" id="clientId" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" placeholder="Introduce tu Client ID">
                </div>
                <div>
                    <label for="blogId" class="block text-sm font-medium text-slate-300 mb-2">ID de tu Blog de Blogger</label>
                    <input type="text" id="blogId" class="w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white" placeholder="El número ID de tu blog">
                </div>
                <div class="flex flex-wrap items-center justify-end gap-2 pt-4">
                     <button id="save_credentials_button" class="custom-btn bg-green-600 hover:bg-green-700 text-white">Guardar Credenciales</button>
                     <button id="clear_credentials_button" class="custom-btn bg-red-600 hover:bg-red-700 text-white">Borrar Credenciales</button>
                     <button id="authorize_button" class="custom-btn bg-blue-600 hover:bg-blue-700 text-white" disabled>Autorizar</button>
                     <button id="signout_button" class="custom-btn bg-gray-600 hover:bg-gray-700 text-white" style="display: none;">Cerrar Sesión</button>
                </div>
                <div id="statusMessage" class="text-slate-400 text-sm h-4 mt-2 text-right"></div>
            </div>
        </div>

        <!-- Contenedor para el CÓDIGO generado -->
        <div id="outputContainer" class="mt-8 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-sky-400">Código HTML Generado</h2>
            <div class="code-block">
                <button id="copyButton" class="copy-button">Copiar</button>
                <code id="outputCode"></code>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let tokenClient;
        let gapiReady = false;
        let gisReady = false;
        let episodeCounter = 0;

        // --- ELEMENTOS DEL DOM ---
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        const outputContainer = document.getElementById('outputContainer');
        const outputCode = document.getElementById('outputCode');
        const copyButton = document.getElementById('copyButton');
        
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const publishButton = document.getElementById('publish_button');
        const statusMessage = document.getElementById('statusMessage');
        const saveCredentialsButton = document.getElementById('save_credentials_button');
        const clearCredentialsButton = document.getElementById('clear_credentials_button');
        
        // TMDb Elements
        const saveTmdbKeyButton = document.getElementById('save_tmdb_key_button');
        const searchBtn = document.getElementById('searchBtn');
        const searchResultsContainer = document.getElementById('searchResultsContainer');

        // Form Type Elements
        const movieFields = document.getElementById('movieFields');
        const seriesFields = document.getElementById('seriesFields');
        const addEpisodeBtn = document.getElementById('addEpisodeBtn');
        const episodesContainer = document.getElementById('episodesContainer');

        // Tab Elements
        const tabGenerator = document.getElementById('tabGenerator');
        const tabConfig = document.getElementById('tabConfig');
        const panelGenerator = document.getElementById('panelGenerator');
        const panelConfig = document.getElementById('panelConfig');

        // --- LÓGICA DE PESTAÑAS ---
        function switchTab(activeTab) {
            if (activeTab === 'generator') {
                panelGenerator.style.display = 'block';
                panelConfig.style.display = 'none';
                tabGenerator.classList.add('tab-active');
                tabGenerator.classList.remove('tab-inactive');
                tabConfig.classList.add('tab-inactive');
                tabConfig.classList.remove('tab-active');
            } else {
                panelGenerator.style.display = 'none';
                panelConfig.style.display = 'block';
                tabConfig.classList.add('tab-active');
                tabConfig.classList.remove('tab-inactive');
                tabGenerator.classList.add('tab-inactive');
                tabGenerator.classList.remove('tab-active');
            }
        }
        tabGenerator.addEventListener('click', () => switchTab('generator'));
        tabConfig.addEventListener('click', () => switchTab('config'));


        // --- LÓGICA DE CAMBIO DE TIPO DE CONTENIDO ---
        document.querySelectorAll('input[name="contentType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'movie') {
                    movieFields.style.display = 'block';
                    seriesFields.style.display = 'none';
                } else {
                    movieFields.style.display = 'none';
                    seriesFields.style.display = 'block';
                    if (episodesContainer.children.length === 0) {
                        addEpisode(); // Añadir el primer episodio si no hay ninguno
                    }
                }
            });
        });

        // --- LÓGICA PARA AÑADIR EPISODIOS ---
        function addEpisode() {
            episodeCounter++;
            const episodeDiv = document.createElement('div');
            episodeDiv.classList.add('flex', 'items-center', 'gap-2');
            episodeDiv.innerHTML = `
                <label for="episode_${episodeCounter}" class="text-sm text-slate-400 whitespace-nowrap">Capítulo ${episodeCounter}:</label>
                <input type="url" id="episode_${episodeCounter}" class="episode-url w-full bg-slate-600 border border-slate-500 rounded-md p-2 text-white" placeholder="URL del embed del episodio" required>
                <button type="button" class="remove-episode-btn custom-btn bg-red-700 hover:bg-red-800 text-white text-xs px-2 py-1">-</button>
            `;
            episodesContainer.appendChild(episodeDiv);

            episodeDiv.querySelector('.remove-episode-btn').addEventListener('click', function() {
                episodeDiv.remove();
                // Re-numerar los labels para que no haya saltos
                document.querySelectorAll('#episodesContainer > div').forEach((div, index) => {
                    div.querySelector('label').textContent = `Capítulo ${index + 1}:`;
                });
                episodeCounter = episodesContainer.children.length;
            });
        }
        addEpisodeBtn.addEventListener('click', addEpisode);


        // --- FUNCIÓN PARA GENERAR HTML ---
        function generateHtmlContent() {
            const type = document.querySelector('input[name="contentType"]:checked').value;
            const imageUrl = document.getElementById('imageUrl').value;
            const synopsis = document.getElementById('synopsis').value;
            const imageAltText = document.getElementById('imageAltText').value || document.getElementById('postTitle').value || 'Póster';


            if (!imageUrl || !synopsis) {
                 alert('Por favor, completa los campos de Título, Imagen y Sinopsis.');
                return null;
            }

            if (type === 'movie') {
                return generateMovieHtml(imageUrl, synopsis, imageAltText);
            } else {
                return generateSeriesHtml(imageUrl, synopsis, imageAltText);
            }
        }

        function generateMovieHtml(imageUrl, synopsis, imageAltText) {
            const server1 = document.getElementById('server1').value;
            const server2 = document.getElementById('server2').value;
            const downloadUrl = document.getElementById('downloadUrl').value;

            if (!server1 || !server2 || !downloadUrl) {
                alert('Por favor, completa todos los campos del formulario de la película.');
                return null;
            }

            return `
<div class="separator" style="clear: both;">
    <a href="${imageUrl}" style="display: block; padding: 1em 0; text-align: center; ">
        <img alt="${imageAltText}" border="0" height="200" src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/1000x1484/1c1c1e/ffffff?text=Error+al+cargar+la+imagen';">
    </a>
</div>
<div class="ctncapitulo">
<ul class="tabs"><li><a href="#tab1">SERVIDOR 1</a></li><li><a href="#tab2">SERVIDOR 2</a></li><li><a href="${downloadUrl}">DESCARGAR</a></li></ul>
    <div class="contenedor_tab">
        <div class="contenido_tab" id="tab1">
            <iframe allowfullscreen="" frameborder="0" height="350" src="${server1}" style="border-radius: 12px;" width="100%"></iframe>
        </div>
        <div class="contenido_tab" id="tab2">
            <center>
                <iframe allowfullscreen="" frameborder="0" height="350" src="${server2}" style="border-radius: 12px;" width="100%"></iframe>
            </center>
        </div>
    </div>
    <b><div style="text-align: center;"><b>&nbsp;Sinopsis:</b></div></b>
    <div class="separator" style="clear: both; text-align: center;">
        <span style="text-align: left;"><span style="font-family: arial; font-size: medium;">${synopsis}</span></span>
    </div>
</div>`;
        }

        function generateSeriesHtml(imageUrl, synopsis, imageAltText) {
            let episodesHtml = '';
            const episodeInputs = document.querySelectorAll('.episode-url');
            if (episodeInputs.length === 0) {
                alert('Por favor, añade al menos un episodio.');
                return null;
            }

            episodeInputs.forEach((input, index) => {
                if (!input.value) return; // Saltar episodios vacíos
                const chapterNum = index + 1;
                episodesHtml += `
<div class="capitulo">
<input class="bt-capitulo" onclick="if (this.parentNode.nextSibling.childNodes[0].style.display != '') { this.parentNode.nextSibling.childNodes[0].style.display = ''; this.value = 'CAPITULO ${chapterNum}'; } else { this.parentNode.nextSibling.childNodes[0].style.display = 'none'; this.value = 'CAPITULO ${chapterNum}'; }" type="button" value="CAPITULO ${chapterNum}" />
</div><div><div class="ctncapitulo" style="display: none;">
<center>
<iframe allowfullscreen="" frameborder="0" height="315" src="${input.value}" style="border-radius: 12px;" width="100%"></iframe>
</center>
</div></div>`;
            });

            return `
<div class="separator" style="clear: both;"><a href="${imageUrl}" style="display: block; padding: 1em 0; text-align: center; "><img alt="${imageAltText}" border="0" height="200" src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/500x750/1c1c1e/ffffff?text=Error+al+cargar+la+imagen';"/></a></div>
<div class="ctncapitulo">
<b><div style="text-align: center;"><b>&nbsp;Sinopsis:</b></div></b><div class="separator" style="clear: both; text-align: center;">
<span style="text-align: left;">
<span style="font-family: arial; font-size: medium;">
${synopsis}
</span>
</span>
</div>
</div>
<br />
${episodesHtml}`;
        }


        // --- LÓGICA DEL GENERADOR DE CÓDIGO ---
        generateCodeBtn.addEventListener('click', function() {
            const generatedHtml = generateHtmlContent();
            if (generatedHtml) {
                outputCode.textContent = generatedHtml.trim();
                outputContainer.classList.remove('hidden');
                outputContainer.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // --- LÓGICA DEL BOTÓN COPIAR (MÉTODO COMPATIBLE) ---
        copyButton.addEventListener('click', function() {
            const textToCopy = outputCode.textContent;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999);
            try {
                const successful = document.execCommand('copy');
                copyButton.textContent = successful ? '¡Copiado!' : 'Error';
            } catch (err) {
                console.error('Error al copiar:', err);
                copyButton.textContent = 'Error';
            }
            document.body.removeChild(tempTextArea);
            setTimeout(() => { copyButton.textContent = 'Copiar'; }, 2000);
        });

        // --- LÓGICA DE CREDENCIALES (LocalStorage) ---
        function saveCredentials() {
            const apiKey = document.getElementById('apiKey').value;
            const clientId = document.getElementById('clientId').value;
            const blogId = document.getElementById('blogId').value;
            if (apiKey && clientId && blogId) {
                localStorage.setItem('bloggerApiKey', apiKey);
                localStorage.setItem('bloggerClientId', clientId);
                localStorage.setItem('bloggerBlogId', blogId);
                statusMessage.textContent = 'Credenciales de Blogger guardadas.';
            } else {
                alert('Por favor, completa los tres campos de credenciales de Blogger para guardar.');
            }
        }

        function loadCredentials() {
            const apiKey = localStorage.getItem('bloggerApiKey');
            const clientId = localStorage.getItem('bloggerClientId');
            const blogId = localStorage.getItem('bloggerBlogId');
            if (apiKey && clientId && blogId) {
                document.getElementById('apiKey').value = apiKey;
                document.getElementById('clientId').value = clientId;
                document.getElementById('blogId').value = blogId;
            }
        }

        function clearCredentials() {
            if (confirm('¿Estás seguro de que quieres borrar las credenciales de Blogger guardadas?')) {
                localStorage.removeItem('bloggerApiKey');
                localStorage.removeItem('bloggerClientId');
                localStorage.removeItem('bloggerBlogId');
                document.getElementById('apiKey').value = '';
                document.getElementById('clientId').value = '';
                document.getElementById('blogId').value = '';
                statusMessage.textContent = 'Credenciales de Blogger borradas.';
            }
        }

        function saveTmdbKey() {
            const tmdbKey = document.getElementById('tmdbApiKey').value;
            if (tmdbKey) {
                localStorage.setItem('tmdbApiKey', tmdbKey);
                alert('Clave de TMDb guardada.');
            } else {
                alert('Por favor, introduce una clave de API de TMDb.');
            }
        }

        function loadTmdbKey() {
            const tmdbKey = localStorage.getItem('tmdbApiKey');
            if (tmdbKey) {
                document.getElementById('tmdbApiKey').value = tmdbKey;
            }
        }

        // --- LÓGICA DE LA API DE TMDb ---
        async function searchContent() {
            const type = document.querySelector('input[name="contentType"]:checked').value;
            const query = document.getElementById('searchInput').value;
            const apiKey = document.getElementById('tmdbApiKey').value;
            if (!apiKey) {
                alert('Por favor, introduce tu API Key de TMDb en la pestaña de Configuración.');
                switchTab('config');
                return;
            }
            if (!query) {
                alert('Por favor, introduce un título para buscar.');
                return;
            }

            searchResultsContainer.innerHTML = '<p class="col-span-full text-center">Buscando...</p>';
            const url = `https://api.themoviedb.org/3/search/${type}?api_key=${apiKey}&query=${encodeURIComponent(query)}&language=es-ES`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                displaySearchResults(data.results, type);
            } catch (error) {
                console.error('Error buscando en TMDb:', error);
                searchResultsContainer.innerHTML = '<p class="col-span-full text-center text-red-500">Error al buscar.</p>';
            }
        }

        function displaySearchResults(results, type) {
            searchResultsContainer.innerHTML = '';
            if (results.length === 0) {
                searchResultsContainer.innerHTML = '<p class="col-span-full text-center">No se encontraron resultados.</p>';
                return;
            }

            results.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.classList.add('search-result-item');
                
                const title = item.title || item.name;
                const releaseDate = item.release_date || item.first_air_date;
                const year = releaseDate ? releaseDate.substring(0, 4) : 'N/A';
                const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w200${item.poster_path}` : 'https://placehold.co/200x300/1c1c1e/ffffff?text=Sin+P%C3%B3ster';

                itemEl.innerHTML = `
                    <img src="${posterPath}" alt="Póster de ${title}">
                    <p>${title} (${year})</p>
                    <button class="custom-btn bg-teal-600 hover:bg-teal-700 text-white w-full" onclick="selectContent(${item.id}, '${type}')">Seleccionar</button>
                `;
                searchResultsContainer.appendChild(itemEl);
            });
        }

        async function selectContent(id, type) {
            const apiKey = document.getElementById('tmdbApiKey').value;
            const detailsUrl = `https://api.themoviedb.org/3/${type}/${id}?api_key=${apiKey}&language=es-ES`;
            const altTitlesUrl = `https://api.themoviedb.org/3/${type}/${id}/alternative_titles?api_key=${apiKey}`;

            try {
                // Fetch details and alternative titles in parallel
                const [detailsResponse, altTitlesResponse] = await Promise.all([
                    fetch(detailsUrl),
                    fetch(altTitlesUrl)
                ]);

                const item = await detailsResponse.json();
                const altTitlesData = await altTitlesResponse.json();

                // Process main details
                const title = item.title || item.name;
                const releaseDate = item.release_date || item.first_air_date;
                const year = releaseDate ? `(${releaseDate.substring(0, 4)})` : '';
                
                document.getElementById('postTitle').value = `${title} ${year}`;
                document.getElementById('imageUrl').value = item.poster_path ? `https://image.tmdb.org/t/p/original${item.poster_path}` : '';
                document.getElementById('synopsis').value = item.overview || 'No hay sinopsis disponible.';
                document.getElementById('postLabels').value = item.genres ? item.genres.map(g => g.name).join(', ') : '';

                // Process alternative titles for the alt tag
                const alternativeTitles = (altTitlesData.titles || altTitlesData.results || [])
                    .map(t => t.title)
                    .filter(t => t && t.trim() !== ''); // Ensure title exists
                
                const allTitles = [title, ...new Set(alternativeTitles)]; // Use Set to avoid duplicates
                document.getElementById('imageAltText').value = allTitles.join(', ');


                searchResultsContainer.innerHTML = '';
                document.getElementById('searchInput').value = '';
                alert(`'${title}' seleccionada. Revisa los campos y completa los que faltan.`);

            } catch (error) {
                console.error('Error obteniendo detalles:', error);
                alert('No se pudieron obtener los detalles.');
            }
        }


        // --- LÓGICA DE LA API DE BLOGGER ---
        function gapiLoaded() {
            gapi.load('client', () => { gapiReady = true; maybeEnableAuthButton(); });
        }
        
        function gisLoaded() {
            gisReady = true;
            maybeEnableAuthButton();
        }

        function maybeEnableAuthButton() {
            if (gapiReady && gisReady) {
                authorizeButton.disabled = false;
            }
        }

        async function handleAuthClick() {
            const apiKey = document.getElementById('apiKey').value;
            const clientId = document.getElementById('clientId').value;

            if (!apiKey || !clientId) {
                alert('Por favor, introduce tu API Key y Client ID de Google antes de autorizar.');
                return;
            }

            statusMessage.textContent = 'Inicializando servicios de Google...';

            await gapi.client.init({
                apiKey: apiKey,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/blogger/v3/rest'],
            });

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/blogger',
                callback: async (resp) => {
                    if (resp.error !== undefined) { throw (resp); }
                    updateSigninStatus(true);
                },
            });

            statusMessage.textContent = 'Abriendo ventana de autorización...';
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateSigninStatus(false);
            }
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                publishButton.disabled = false;
                statusMessage.textContent = "Autorización exitosa.";
            } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
                publishButton.disabled = true;
                statusMessage.textContent = "Necesitas autorizar para poder publicar.";
            }
        }

        async function publishPost() {
            publishButton.disabled = true;
            statusMessage.textContent = "Publicando...";
            
            const blogId = document.getElementById('blogId').value;
            const title = document.getElementById('postTitle').value;
            const labels = document.getElementById('postLabels').value.split(',').map(s => s.trim()).filter(Boolean);
            
            if (!blogId || !title) {
                alert('El Título de la entrada y el ID del Blog son obligatorios para publicar.');
                statusMessage.textContent = "Error: Faltan datos.";
                publishButton.disabled = false;
                return;
            }

            const content = generateHtmlContent();
            if (!content) {
                 statusMessage.textContent = "Error: No se pudo generar el contenido.";
                 publishButton.disabled = false;
                 return;
            }
            
            try {
                const response = await gapi.client.blogger.posts.insert({
                    'blogId': blogId,
                    'resource': {
                        'title': title,
                        'content': content,
                        'labels': labels
                    }
                });
                console.log('Post created:', response.result);
                statusMessage.textContent = `¡Publicado con éxito! Ver entrada: ${response.result.url}`;
            } catch (err) {
                console.error('Execute error', err);
                statusMessage.textContent = `Error al publicar: ${err.result.error.message}`;
            } finally {
                 publishButton.disabled = false;
            }
        }
        
        // --- EVENT LISTENERS ---
        authorizeButton.addEventListener('click', handleAuthClick);
        signoutButton.addEventListener('click', handleSignoutClick);
        publishButton.addEventListener('click', publishPost);
        saveCredentialsButton.addEventListener('click', saveCredentials);
        clearCredentialsButton.addEventListener('click', clearCredentials);
        saveTmdbKeyButton.addEventListener('click', saveTmdbKey);
        searchBtn.addEventListener('click', searchContent);
        
        // --- INICIALIZACIÓN ---
        window.addEventListener('load', () => {
            loadCredentials();
            loadTmdbKey();
            addEpisode(); // Añadir el primer episodio por defecto
        });
        
    </script>
</body>
</html>
